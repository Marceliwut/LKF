{% extends 'layouts/base.html' %}
{% load static %}
{% block content %}
<div class="content">
  <div class="row">
    <div class="col-md-6 offset-md-3">
      <div class="card">
        <div class="card-header">
          <h5 class="title">Zmień hasło</h5>
          <p class="text-muted">Zmień swoje hasło</p>
        </div>
        <div class="card-body">
          {% if message %}
            <div class="alert {% if success %}alert-success{% else %}alert-danger{% endif %} alert-with-icon" id="messageAlert" data-notify="container">
              <button type="button" class="close" data-dismiss="alert" aria-label="Close" onclick="closeAlert('messageAlert')" {% if show_countdown %}style="display:none;"{% endif %}>
                <span aria-hidden="true">&times;</span>
              </button>
              <span data-notify="icon" class="nc-icon {% if success %}nc-check-2{% else %}nc-close-circle{% endif %}"></span>
              <span data-notify="message">{{ message }}{% if show_countdown %}<br><small id="countdown-text">Przekierowanie za <span id="countdown">5</span> sekund...</small>{% endif %}</span>
            </div>
          {% endif %}

          <form method="post" action="{% url 'change_password' %}">
            {% csrf_token %}

            <!-- Current Password Field -->
            <div class="form-group">
              <label for="current_password">{{ form.current_password.label }}</label>
              {{ form.current_password }}
              {% if form.current_password.errors %}
                <div class="text-danger mt-2">
                  {% for error in form.current_password.errors %}
                    <small>{{ error }}</small>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- New Password Field -->
            <div class="form-group">
              <label for="new_password">{{ form.new_password.label }}</label>
              {{ form.new_password }}
              {% if form.new_password.errors %}
                <div class="text-danger mt-2">
                  {% for error in form.new_password.errors %}
                    <small>{{ error }}</small>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- Confirm Password Field -->
            <div class="form-group">
              <label for="confirm_password">{{ form.confirm_password.label }}</label>
              {{ form.confirm_password }}
              {% if form.confirm_password.errors %}
                <div class="text-danger mt-2">
                  {% for error in form.confirm_password.errors %}
                    <small>{{ error }}</small>
                  {% endfor %}
                </div>
              {% endif %}
            </div>

            <!-- Form errors -->
            {% if form.non_field_errors %}
              <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                  <div>{{ error }}</div>
                {% endfor %}
              </div>
            {% endif %}

            <div class="text-center mt-4">
              <button type="submit" class="btn btn-primary btn-fill">Zmień hasło</button>
              <a href="{% url 'index' %}" class="btn btn-secondary ml-2">Anuluj</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function closeAlert(id) {
    var alert = document.getElementById(id);
    if (alert) {
      alert.style.transition = 'opacity 0.5s ease-out';
      alert.style.opacity = '0';
      setTimeout(function() {
        alert.remove();
      }, 500);
    }
  }
  
  // Handle countdown and redirect on success
  {% if show_countdown %}
  var countdownElement = document.getElementById('countdown');
  var countdownValue = 5;
  
  var countdownInterval = setInterval(function() {
    countdownValue--;
    if (countdownElement) {
      countdownElement.textContent = countdownValue;
    }
    
    if (countdownValue <= 0) {
      clearInterval(countdownInterval);
      window.location.href = '{% url "auth_signin" %}';
    }
  }, 1000);
  {% else %}
  // Auto-close error message after 5 seconds
  if (document.getElementById('messageAlert')) {
    setTimeout(function() {
      closeAlert('messageAlert');
    }, 5000);
  }
  {% endif %}
</script>
{% endblock %}
