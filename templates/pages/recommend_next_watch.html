<!-- filepath: c:\Users\mmirz\OneDrive\LKF\lkf\templates\pages\recommend_next_watch.html -->
{% extends 'layouts/base.html' %}
{% block content %}

<div class="content">
    <h1 class="text-center text-primary fw-bold" style="margin-top:30px;">Na kolejne spotkanie:</h1>

    {% if error %}
    <div class="alert alert-danger text-center">
        {{ error }}
    </div>
    {% else %}
    <div class="row justify-content-center">
        {% if recommendations.latest %}
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">Następny w kolejności:</h2>
                    <p><strong><h4>{{ recommendations.latest.id }}. {{ recommendations.latest.title }}</h4></strong></p>
                    <p>Year: {{ recommendations.latest.year }}</p>
                    <p>Czas trwania: {{ recommendations.latest.duration }}</p>
                    <p>Opis: {{ recommendations.latest.description }}</p>
                </div>
            </div>
        </div>
        {% endif %}

        {% if recommendations.shortest %}
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">Najkrótszy</h2>
                    <p><strong id="shortest-title"><h4>{{ recommendations.shortest.id }}. {{ recommendations.shortest.title }}</h4></strong></p>
                    <p>ID: <span id="shortest-id">{{ recommendations.shortest.id }}</span></p>
                    <p>Rok: <span id="shortest-year">{{ recommendations.shortest.year }}</span></p>
                    <p>Czas trwania: <span id="shortest-duration">{{ recommendations.shortest.duration }}</span></p>
                    <p>Opis: <span id="shortest-description">{{ recommendations.shortest.description }}</span></p>
                    {% comment %} <button id="find-next-shortest" class="btn btn-primary mt-3">Find Another Shortest</button> {% endcomment %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Display Total Duration -->
    <div class="text-center mt-4">
        <h3>Nowy film: {{ recommendations.shortest.id }}. {{ recommendations.shortest.title }}</h3>
        <h3>Łącznie czasowo: {{ total_hours }}h {{ total_minutes }}m</h3>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const button = document.getElementById("find-next-shortest");

        if (!button) {
            console.error("Button with ID 'find-next-shortest' not found.");
            return;
        }

        button.addEventListener("click", function () {
            const shortestIdElement = document.getElementById("shortest-id");
            if (!shortestIdElement) {
                console.error("Element with ID 'shortest-id' not found.");
                return;
            }

            const currentShortestId = shortestIdElement.textContent;
            console.log("Button clicked. Current shortest ID:", currentShortestId);

            fetch("{% url 'find_next_shortest_movie' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                body: JSON.stringify({ current_shortest_id: currentShortestId }),
            })
            .then(response => {
                console.log("Response received:", response);
                return response.json();
            })
            .then(data => {
                console.log("Data received from server:", data);
                if (data.status === "success") {
                    // Update the DOM with the new shortest movie details
                    document.getElementById("shortest-title").textContent = `${data.movie.id}. ${data.movie.title}`;
                    document.getElementById("shortest-id").textContent = data.movie.id;
                    document.getElementById("shortest-year").textContent = data.movie.year;
                    document.getElementById("shortest-duration").textContent = data.movie.duration;
                    document.getElementById("shortest-description").textContent = data.movie.description;

                    // Update the h3 element with the new title and ID
                    const h3Element = document.querySelector(".text-center h3");
                    if (h3Element) {
                        h3Element.textContent = `Nowy film: ${data.movie.id}. ${data.movie.title}`;
                    }

                    // Update the total duration dynamically
                    const nextMovieDurationElement = document.querySelector(".col-md-6:nth-child(1) .card-body p:nth-child(3)");
                    if (nextMovieDurationElement) {
                        const nextMovieDuration = nextMovieDurationElement.textContent.trim();
                        const newShortestDuration = data.movie.duration;

                        const totalMinutes = calculateNewTotalMinutes(nextMovieDuration) + calculateNewTotalMinutes(newShortestDuration);
                        const totalHours = Math.floor(totalMinutes / 60);
                        const remainingMinutes = totalMinutes % 60;

                        const totalDurationElement = document.querySelector(".text-center h3 + h3");
                        if (totalDurationElement) {
                            totalDurationElement.textContent = `Łącznie czasowo: ${totalHours}h ${remainingMinutes}m`;
                        }
                    }
                } else {
                    console.error("Error from server:", data.message);
                    alert(data.message);
                }
            })
            .catch(error => {
                console.error("Fetch error:", error);
                alert("An error occurred while finding the next shortest movie.");
            });
        });

        // Function to get the CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie) {
                const cookies = document.cookie.split(";");
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Function to calculate total minutes from a duration string
        function calculateNewTotalMinutes(duration) {
            const durationMatch = duration.match(/(\d+)h\s*(\d+)?m?/);
            if (durationMatch) {
                const hours = parseInt(durationMatch[1] || "0", 10);
                const minutes = parseInt(durationMatch[2] || "0", 10);
                return hours * 60 + minutes;
            }
            return 0;
        }
    });
</script>

{% endblock %}