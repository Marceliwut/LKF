<!-- filepath: c:\Users\mmirz\OneDrive\LKF\lkf\templates\pages\dashboard.html -->
{% extends 'layouts/base.html' %}
{% load static %}
{% load static %}
{% block content %}
<div class="content">
  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h5 class="title">Zarządzanie użytkownikami</h5>
          <p class="text-muted">Lista wszystkich użytkowników w systemie</p>
        </div>
        <div class="card-body">
          {% if error %}
            <div class="alert alert-danger alert-with-icon" id="errorAlert" data-notify="container">
              <button type="button" class="close" data-dismiss="alert" aria-label="Close" onclick="closeAlert('errorAlert')">
                <span aria-hidden="true">&times;</span>
              </button>
              <span data-notify="icon" class="nc-icon nc-bell-55"></span>
              <span data-notify="message">{{ error }}</span>
            </div>
          {% endif %}
          
          {% if message %}
            <div class="alert alert-success alert-with-icon" id="successAlert" data-notify="container">
              <button type="button" class="close" data-dismiss="alert" aria-label="Close" onclick="closeAlert('successAlert')">
                <span aria-hidden="true">&times;</span>
              </button>
              <span data-notify="icon" class="nc-icon nc-check-2"></span>
              <span data-notify="message">{{ message }}</span>
            </div>
          {% endif %}
          
          <form method="post" action="{% url 'admin' %}">
            {% csrf_token %}
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th style="width: 30px;">
                      <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    </th>
                    <th>ID</th>
                    <th>Nazwa użytkownika</th>
                    <th>Email</th>
                    <th>Limit propozycji</th>
                    <th>Data dołączenia</th>
                    <th>Ostatnia aktywność</th>
                    <th>Akcje</th>
                  </tr>
                </thead>
                <tbody>
                  {% for user in users %}
                    <tr>
                      <td>
                        <input type="checkbox" name="user_ids" value="{{ user.id }}" class="user-checkbox">
                      </td>
                      <td>{{ user.id }}</td>
                      <td>{{ user.username }}</td>
                      <td>{{ user.email }}</td>
                      <td>{{ user.proposal_limit_value }}</td>
                      <td>{{ user.date_joined|date:"Y-m-d H:i" }}</td>
                      <td>{{ user.last_login|date:"Y-m-d H:i" }}</td>
                      <td>
                        <button type="button" class="btn btn-sm btn-info" data-toggle="modal" data-target="#resetPasswordModal" onclick="setResetUserId({{ user.id }}, '{{ user.username }}')">
                          Resetuj hasło
                        </button>
                      </td>
                    </tr>
                  {% empty %}
                    <tr>
                      <td colspan="7" class="text-center">Brak użytkowników do wyświetlenia</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
            <div class="card-footer">
              <button type="submit" id="remove-users-btn" class="btn btn-fill" name="action" value="delete" onclick="return confirm('Czy na pewno chcesz usunąć wybranych użytkowników?')" style="background-color: #ef8157 !important; color: white !important;">
                Usuń wybranych użytkowników
              </button>
              <button type="button" class="btn btn-fill" name="action" value="extend_limit" onclick="openExtendLimitModal()" style="background-color: #51bcda !important; color: white !important; margin-left: 10px;">
                Rozszerz limit propozycji
              </button>
            </div>
          </form>
        </div>
        
      </div>
    </div>
  </div>
</div>

<script>
  function toggleSelectAll() {
    var selectAll = document.getElementById('selectAll');
    var checkboxes = document.querySelectorAll('.user-checkbox');
    checkboxes.forEach(function(checkbox) {
      checkbox.checked = selectAll.checked;
    });
  }
  
  function closeAlert(id) {
    var alert = document.getElementById(id);
    if (alert) {
      alert.style.transition = 'opacity 0.5s ease-out';
      alert.style.opacity = '0';
      setTimeout(function() {
        alert.remove();
      }, 500);
    }
  }
  
  // Auto-close success message after 5 seconds
  if (document.getElementById('successAlert')) {
    setTimeout(function() {
      closeAlert('successAlert');
    }, 5000);
  }

  function openExtendLimitModal() {
    var checkboxes = document.querySelectorAll('.user-checkbox:checked');
    if (checkboxes.length === 0) {
      alert('Proszę wybrać co najmniej jednego użytkownika.');
      return;
    }
    document.getElementById('extendLimitModal').style.display = 'block';
  }

  function submitExtendLimit() {
    var additionalLimit = parseInt(document.getElementById('additionalLimit').value);
    if (!additionalLimit || additionalLimit <= 0) {
      alert('Proszę wpisać liczbę większą od 0.');
      return;
    }
    
    // Create hidden form and submit
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = '{% url "admin" %}';
    
    // Add CSRF token
    var csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = '{{ csrf_token }}';
    form.appendChild(csrfInput);
    
    // Add action
    var actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'extend_limit';
    form.appendChild(actionInput);
    
    // Add additional limit
    var limitInput = document.createElement('input');
    limitInput.type = 'hidden';
    limitInput.name = 'additional_limit';
    limitInput.value = additionalLimit;
    form.appendChild(limitInput);
    
    // Add selected user IDs
    var checkboxes = document.querySelectorAll('.user-checkbox:checked');
    checkboxes.forEach(function(checkbox) {
      var userIdInput = document.createElement('input');
      userIdInput.type = 'hidden';
      userIdInput.name = 'user_ids';
      userIdInput.value = checkbox.value;
      form.appendChild(userIdInput);
    });
    
    document.body.appendChild(form);
    form.submit();
  }

  function closeModal() {
    document.getElementById('extendLimitModal').style.display = 'none';
    document.getElementById('additionalLimit').value = '';
  }

  // Close modal when clicking outside
  window.onclick = function(event) {
    var modal = document.getElementById('extendLimitModal');
    if (event.target == modal) {
      modal.style.display = 'none';
    }
  }
</script>

<!-- Extend Limit Modal -->
<div id="extendLimitModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.4);">
  <div class="modal-content" style="background-color: #1a1a2e; color: #fff; margin: 10% auto; padding: 20px; border: 1px solid #333; border-radius: 5px; width: 400px;">
    <span class="close" onclick="closeModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
    <h2 style="margin-top: 0;">Rozszerz limit propozycji</h2>
    <p>Ile dodatkowych propozycji dodać do limitu wybranym użytkownikom?</p>
    <div style="margin: 20px 0;">
      <label for="additionalLimit" style="color: #fff; display: block; margin-bottom: 10px;">Liczba dodatkowych propozycji:</label>
      <input type="number" id="additionalLimit" min="1" max="50" value="5" style="width: 100%; padding: 10px; background-color: #2a2a3e; color: #fff; border: 1px solid #333; border-radius: 4px; box-sizing: border-box;">
    </div>
    <div style="text-align: right; margin-top: 20px;">
      <button onclick="closeModal()" style="padding: 10px 20px; margin-right: 10px; background-color: #555; color: #fff; border: none; border-radius: 4px; cursor: pointer;">Anuluj</button>
      <button onclick="submitExtendLimit()" style="padding: 10px 20px; background-color: #51bcda; color: #fff; border: none; border-radius: 4px; cursor: pointer;">Rozszerz</button>
    </div>
  </div>
</div>

<!-- Password Reset Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" role="dialog" aria-labelledby="resetPasswordLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content" style="background-color: #1a1a2e; color: #fff;">
      <div class="modal-header" style="border-bottom: 1px solid #333;">
        <h5 class="modal-title" id="resetPasswordLabel">Resetuj hasło użytkownika</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #fff;">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="resetPasswordError" class="alert alert-danger" style="display:none;"></div>
        <form id="resetPasswordForm">
          <input type="hidden" id="resetUserId" value="">
          <div class="form-group">
            <label style="color: #fff;">Nazwa użytkownika: <strong id="resetUsername"></strong></label>
          </div>
          <div class="form-group">
            <label for="newPassword" style="color: #fff;">Nowe hasło</label>
            <input type="password" class="form-control" id="newPassword" placeholder="Nowe hasło" required style="background-color: #2a2a3e; color: #fff; border-color: #333;">
          </div>
          <div class="form-group">
            <label for="confirmPassword" style="color: #fff;">Potwierdź hasło</label>
            <input type="password" class="form-control" id="confirmPassword" placeholder="Potwierdź hasło" required style="background-color: #2a2a3e; color: #fff; border-color: #333;">
          </div>
        </form>
      </div>
      <div class="modal-footer" style="border-top: 1px solid #333;">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Anuluj</button>
        <button type="button" class="btn btn-primary" onclick="submitResetPassword()">Resetuj hasło</button>
      </div>
    </div>
  </div>
</div>

<script>
  var resetUserId = null;
  var resetUsername = null;

  function setResetUserId(userId, username) {
    resetUserId = userId;
    resetUsername = username;
    document.getElementById('resetUserId').value = userId;
    document.getElementById('resetUsername').textContent = username;
    document.getElementById('resetPasswordError').style.display = 'none';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
  }

  function submitResetPassword() {
    var newPassword = document.getElementById('newPassword').value;
    var confirmPassword = document.getElementById('confirmPassword').value;
    var errorDiv = document.getElementById('resetPasswordError');

    // Client-side validation
    if (!newPassword || !confirmPassword) {
      errorDiv.textContent = 'Proszę wypełnić wszystkie pola.';
      errorDiv.style.display = 'block';
      return;
    }

    if (newPassword !== confirmPassword) {
      errorDiv.textContent = 'Hasła się nie zgadzają.';
      errorDiv.style.display = 'block';
      return;
    }

    if (newPassword.length < 8) {
      errorDiv.textContent = 'Hasło musi mieć co najmniej 8 znaków.';
      errorDiv.style.display = 'block';
      return;
    }

    // Send AJAX request to reset password
    fetch('{% url "reset_user_password" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        user_id: resetUserId,
        new_password: newPassword,
        confirm_password: confirmPassword
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        // Close modal and show success message
        $('#resetPasswordModal').modal('hide');
        alert(data.message);
        location.reload();
      } else {
        errorDiv.textContent = data.message;
        errorDiv.style.display = 'block';
      }
    })
    .catch(error => {
      errorDiv.textContent = 'Błąd komunikacji z serwerem.';
      errorDiv.style.display = 'block';
    });
  }
</script>

{% endblock content %}