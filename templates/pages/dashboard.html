{% extends 'layouts/base.html' %}
{% load static %}
{% block content %}

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".update-btn").forEach(button => {
            button.addEventListener("click", function () {
                const title = this.getAttribute("data-title");
                const field = this.getAttribute("data-field");
                button.disabled = true;

                fetch("update_entry/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken"),
                    },
                    body: JSON.stringify({ title: title, field: field }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        const statusSpan = button.parentElement.querySelector(
                            field === "watched" ? "p:nth-of-type(1) span" : "p:nth-of-type(2) span"
                        );
                        if (statusSpan) {
                            statusSpan.textContent = statusSpan.textContent === "Tak" ? "Nie" : "Tak";
                            statusSpan.className = statusSpan.textContent === "Tak" ? "text-success" : "text-danger";
                        }
                        alert(data.message);
                    } else {
                        alert(`Error: ${data.message}`);
                    }
                    button.disabled = false;
                })
                .catch(error => {
                    console.error("Error:", error);
                    button.disabled = false;
                });
            });
        });

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie) {
                const cookies = document.cookie.split(";");
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + "=")) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>

<div class="content">
    <h1 class="text-center text-primary fw-bold">Lemorkowy Klub Filmowy</h1>

    <!-- Filter Buttons -->
    <div class="btn-group d-flex justify-content-center mb-3">
        <a href="{% url 'index' %}?filter=not_watched" class="btn btn-info mx-1 {% if request.GET.filter == 'not_watched' %}active{% endif %}">Do oglądnięcia</a>
        <a href="{% url 'index' %}?filter=watched" class="btn btn-info mx-1 {% if request.GET.filter == 'watched' %}active{% endif %}">Oglądnięte</a>
        <a href="{% url 'index' %}?filter=skipped" class="btn btn-info mx-1 {% if request.GET.filter == 'skipped' %}active{% endif %}">Skipped</a>
    </div>

    <!-- Recommendation Button -->
    <div class="text-center mb-3">
        <a href="{% url 'recommend_next_watch' %}" class="btn btn-primary">Get Recommendation</a>
    </div>
    <!-- Search Bar -->
    <form method="get" action="{% url 'index' %}" class="text-center mb-3">
        <div class="input-group" style="max-width: 500px; margin: 0 auto;">
            <input type="text" name="search" class="form-control" placeholder="Szukaj po tytule" value="{{ search_query }}">
            <input type="hidden" name="filter" value="{{ request.GET.filter }}">
            <input type="hidden" name="sort" value="{{ request.GET.sort }}">
            <button class="btn btn-secondary" type="submit">Szukaj</button>
        </div>
    </form>

    <!-- Movie Cards -->
    <div class="row">
        {% for row in csv_data|slice:"1:" %}
        <div class="col-12 mb-4">
            <div class="card">
                <div class="row g-0">
                    <div class="col-md-4">
                        {% if row|length > 12 and row.12 %}
                        <img src="{{ row.12 }}" style="max-height:400px;" class="img-fluid rounded-start" alt="{{ row.1 }}">
                        {% else %}
                        <img src="{% static '/assets/img/knur.png' %}" class="img-fluid rounded-start" alt="No poster available">
                        {% endif %}
                    </div>
                    <div class="col-md-8">
                        <div class="card-body">
                            <h2>{{ row.0 }}. {{ row.1 }}</h2>
                            <h3>Rok: {{ row.2 }}</h3>
                            <h4>Czas trwania: {{ row.3 }}</h4>
                            <p>{{ row.8 }}</p>
                            <p>Oglądnięte: <span class="{% if row.9 == 'TRUE' %}text-success{% else %}text-danger{% endif %}">{% if row.9 == 'TRUE' %}Tak{% else %}Nie{% endif %}</span></p>
                            <p>Skipnięte: <span class="{% if row.10 == 'TRUE' %}text-danger{% else %}text-success{% endif %}">{% if row.10 == 'TRUE' %}Tak{% else %}Nie{% endif %}</span></p>
                            <button class="btn btn-success update-btn" data-id="{{ row.0 }}" data-title="{{ row.1 }}" data-field="watched">Oglądnięte</button>
                            <button class="btn update-btn" data-id="{{ row.0 }}" data-title="{{ row.1 }}" data-field="skipped">Skipnij</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{% endblock %}